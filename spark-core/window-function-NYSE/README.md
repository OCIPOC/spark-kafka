
```
// find price change of the recorded period in the file

df2.withColumn("record_start_date", min("date").over(Window.partitionBy("symbol")))
   .withColumn("record_end_date",max("date").over(Window.partitionBy("symbol"))).sort("symbol")
   .filter($"date" === $"record_start_date" || $"date" === $"record_end_date")
   .withColumn("period",datediff(to_date($"record_end_date","yyyyMMdd"),to_date($"record_start_date","yyyyMMdd")))
   .withColumn("end_day_close",lead($"close",1).over(Window.partitionBy($"symbol").orderBy($"date")))
   .withColumn("price_change",round($"end_day_close" - $"open",2)).filter($"end_day_close".isNotNull)
   .withColumn("change_percerntage",round($"price_change" / $"open",2)).show

+------+--------+------+------+-----------------+---------------+------+-------------+------------+------------------+
|symbol|    date|  open| close|record_start_date|record_end_date|period|end_day_close|price_change|change_percerntage|
+------+--------+------+------+-----------------+---------------+------+-------------+------------+------------------+
|     A|20170102| 45.56| 45.56|         20170102|       20170117|    15|        48.32|        2.76|              0.06|
|    AA|20170102| 28.08| 28.08|         20170102|       20170117|    15|        32.64|        4.56|              0.16|
|   AAC|20170102|  7.24|  7.24|         20170102|       20170117|    15|          8.0|        0.76|               0.1|
|   AAN|20170102| 31.99| 31.99|         20170102|       20170117|    15|        32.02|        0.03|               0.0|
|   AAP|20170102|169.12|169.12|         20170102|       20170117|    15|        173.0|        3.88|              0.02|
|   AAT|20170102| 43.08| 43.08|         20170102|       20170117|    15|        43.17|        0.09|               0.0|
|   AAV|20170102|  6.75|  6.75|         20170102|       20170117|    15|          6.5|       -0.25|             -0.04|
|    AB|20170102| 23.45| 23.45|         20170102|       20170117|    15|        23.15|        -0.3|             -0.01|
|   ABB|20170102| 21.07| 21.07|         20170102|       20170117|    15|        22.33|        1.26|              0.06|
|  ABBV|20170102| 62.62| 62.62|         20170102|       20170117|    15|        61.86|       -0.76|             -0.01|
|   ABC|20170102| 78.19| 78.19|         20170102|       20170117|    15|        85.99|         7.8|               0.1|
|  ABEV|20170102|  4.91|  4.91|         20170102|       20170117|    15|         5.34|        0.43|              0.09|
|   ABG|20170102|  61.7|  61.7|         20170102|       20170117|    15|        64.55|        2.85|              0.05|
|   ABM|20170102| 40.84| 40.84|         20170102|       20170117|    15|        39.79|       -1.05|             -0.03|
|   ABR|20170102|  7.46|  7.46|         20170102|       20170117|    15|         7.53|        0.07|              0.01|
| ABR-A|20170102| 25.07| 25.07|         20170102|       20170117|    15|        25.33|        0.26|              0.01|
| ABR-B|20170102| 24.58| 24.58|         20170102|       20170117|    15|        24.92|        0.34|              0.01|
| ABR-C|20170102| 25.35| 25.35|         20170102|       20170117|    15|        25.74|        0.39|              0.02|
|  ABRN|20170102|  25.3|  25.3|         20170102|       20170117|    15|        25.68|        0.38|              0.02|
|   ABT|20170102| 38.41| 38.41|         20170102|       20170117|    15|         40.9|        2.49|              0.06|
+------+--------+------+------+-----------------+---------------+------+-------------+------------+------------------+
```

## DF2
```
scala> df2.sort("symbol").show
+------+--------+-----+-----+
|symbol|    date| open|close|
+------+--------+-----+-----+
|     A|20170102|45.56|45.56|
|     A|20170116|48.69|48.69|
|     A|20170113| 48.6|48.69|
|     A|20170117|48.37|48.32|
|     A|20170103|45.93|46.49|
|     A|20170104|46.93| 47.1|
|     A|20170109|48.01|48.14|
|     A|20170110|48.34| 48.1|
|     A|20170105|47.05|46.54|
|     A|20170111|48.03|49.25|
|     A|20170112| 48.9|48.52|
|     A|20170106|46.63|47.99|
|    AA|20170110|29.83|30.98|
|    AA|20170104|29.02|30.26|
|    AA|20170103| 28.6|28.83|
|    AA|20170109|30.88|29.48|
|    AA|20170112| 33.0|33.04|
|    AA|20170106|30.69|30.68|
|    AA|20170111|31.08|31.97|
|    AA|20170105|30.18|30.65|
+------+--------+-----+-----+
only showing top 20 rows

```
